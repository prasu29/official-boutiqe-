import React, { useState, useEffect } from 'react';
import { BrowserRouter as Router, Routes, Route, Link, Navigate, useNavigate } from 'react-router-dom';

// Lakshmi Boutique - Single-file React app (preview). Uses localStorage as a simple backend.
// Features implemented:
// - Separate Admin and User login (admin has preset credentials)
// - Signup and Login for users (stored in localStorage)
// - Admin product CRUD (upload image as Base64, edit, remove)
// - Product listing, product details, add to cart
// - Simple checkout flow with placeholder for payment integrations (Stripe/PayPal)
// - WhatsApp contact + pickup notes displayed on site
// - Notifications to users when admin updates products (simple in-app 'news' feed)
// - All code in one file for quick testing. Tailwind CSS classes are used (you can remove/replace with plain CSS).

// IMPORTANT: This is a demo single-file app for local testing and small deployments. For a production site:
// - Add a real backend (Node/Express, Django, etc.) with secure authentication and a database.
// - Use a cloud storage (S3) for images, and integrate a payments gateway (Stripe/PayPal/Paytm/Razorpay).
// - Serve over HTTPS and follow security best practices.

// --------- Utilities & Defaults ----------
const ADMIN_EMAIL = 'admin@lakshmi.com';
const ADMIN_PASSWORD = 'Lakshmi@123';
const WHATSAPP = '+91 86392 99665';

function uid() { return Math.random().toString(36).slice(2, 9); }

// localStorage keys
const LS = {
  PRODUCTS: 'lb_products_v1',
  USERS: 'lb_users_v1',
  SESS: 'lb_session_v1',
  NEWS: 'lb_news_v1'
};

function readLS(key, fallback) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; } }
function writeLS(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

// bootstrap sample products if none
function seedProducts() {
  const existing = readLS(LS.PRODUCTS, null);
  if (!existing) {
    const samples = [
      { id: uid(), title: 'Red Silk Sari', price: 2499, qty: 5, desc: 'Beautiful red silk sari - handwork', image: null },
      { id: uid(), title: 'Blue Cotton Dress', price: 1499, qty: 8, desc: 'Comfortable cotton dress - daily wear', image: null },
    ];
    writeLS(LS.PRODUCTS, samples);
  }
}

seedProducts();

// --------- App ----------
export default function LakshmiBoutiqueApp() {
  return (
    <Router>
      <div className="min-h-screen bg-gray-50">
        <Header />
        <main className="container mx-auto p-4">
          <Routes>
            <Route path="/" element={<Home />} />
            <Route path="/login" element={<Login />} />
            <Route path="/signup" element={<Signup />} />
            <Route path="/admin/*" element={<AdminRoutes />} />
            <Route path="/product/:id" element={<ProductDetails />} />
            <Route path="/cart" element={<CartPage />} />
            <Route path="/news" element={<NewsPage />} />
            <Route path="*" element={<NotFound />} />
          </Routes>
        </main>
        <Footer />
      </div>
    </Router>
  );
}

// --------- Header & Footer ----------
function Header() {
  const session = readLS(LS.SESS, null);
  const navigate = useNavigate();
  const handleLogout = () => { localStorage.removeItem(LS.SESS); navigate('/'); };
  return (
    <header className="bg-white shadow-sm">
      <div className="container mx-auto flex items-center justify-between p-4">
        <Link to="/" className="text-2xl font-bold">Lakshmi Boutique</Link>
        <nav className="space-x-4">
          <Link to="/">Home</Link>
          <Link to="/news">Updates</Link>
          <Link to="/cart">Cart</Link>
          {session ? (
            <>
              <span className="mx-2">Hello, {session.name}</span>
              {session.isAdmin ? <Link to="/admin">Admin</Link> : null}
              <button onClick={handleLogout} className="ml-2 underline">Logout</button>
            </>
          ) : (
            <>
              <Link to="/login">Login</Link>
              <Link to="/signup">Sign up</Link>
            </>
          )}
        </nav>
      </div>
    </header>
  );
}

function Footer() {
  return (
    <footer className="mt-8 bg-white border-t">
      <div className="container mx-auto p-4 flex justify-between">
        <div>
          <div className="font-semibold">Contact</div>
          <div>WhatsApp: {WHATSAPP}</div>
          <div className="text-sm mt-2">1. Your cloths material will be picked-up from your home — our shop person will come to your house.<br/>2. The first time pick-up is free.</div>
        </div>
        <div className="text-right text-sm">&copy; Lakshmi Boutique</div>
      </div>
    </footer>
  );
}

// --------- Pages ----------
function Home() {
  const products = readLS(LS.PRODUCTS, []);
  return (
    <div>
      <Hero />
      <section className="mt-6">
        <h2 className="text-xl font-semibold mb-4">Products</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          {products.map(p => (
            <ProductCard key={p.id} p={p} />
          ))}
        </div>
      </section>
    </div>
  );
}

function Hero() {
  return (
    <div className="bg-white p-6 rounded shadow-sm flex items-center justify-between">
      <div>
        <h1 className="text-2xl font-bold">Welcome to Lakshmi Boutique</h1>
        <p className="mt-2">Low and reasonable prices. Admin-managed catalogue. Pickup service available.</p>
        <div className="mt-3">
          <Link to="/signup" className="px-3 py-2 bg-indigo-600 text-white rounded">Shop Now</Link>
        </div>
      </div>
      <div className="hidden md:block w-48">
        <img src={`data:image/svg+xml;utf8,${encodeURIComponent(dummyImageSVG())}`} alt="banner" />
      </div>
    </div>
  );
}

function dummyImageSVG() {
  return `<svg xmlns='http://www.w3.org/2000/svg' width='300' height='150'><rect width='100%' height='100%' fill='#f3f4f6'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#9ca3af' font-size='18'>Lakshmi Boutique</text></svg>`;
}

function ProductCard({ p }) {
  const navigate = useNavigate();
  const handleView = () => navigate(`/product/${p.id}`);
  return (
    <div className="bg-white p-4 rounded shadow-sm">
      <div className="h-48 flex items-center justify-center bg-gray-100 mb-3">{p.image ? <img src={p.image} alt={p.title} className="max-h-full"/> : <div className="text-sm">No image</div>}</div>
      <h3 className="font-semibold">{p.title}</h3>
      <div className="text-sm text-gray-600">₹{p.price} | Stock: {p.qty}</div>
      <div className="mt-2 flex justify-between">
        <button onClick={handleView} className="underline">View</button>
      </div>
    </div>
  );
}

// --------- Product Details & Cart ----------
function ProductDetails() {
  const { pathname } = window.location;
  const id = pathname.split('/').pop();
  const products = readLS(LS.PRODUCTS, []);
  const p = products.find(x => x.id === id);
  const navigate = useNavigate();
  if (!p) return <div>Product not found. <Link to="/">Go home</Link></div>;
  const handleAdd = () => {
    const cart = readLS('lb_cart_v1', []);
    const existing = cart.find(i => i.id === p.id);
    if (existing) existing.qty += 1; else cart.push({ id: p.id, title: p.title, price: p.price, qty: 1, image: p.image });
    writeLS('lb_cart_v1', cart);
    alert('Added to cart');
    navigate('/cart');
  };
  return (
    <div className="bg-white p-4 rounded shadow-sm">
      <div className="md:flex gap-6">
        <div className="md:w-1/3 bg-gray-100 flex items-center justify-center h-64">{p.image ? <img src={p.image} alt={p.title} className="max-h-full"/> : 'No image'}</div>
        <div className="md:flex-1">
          <h2 className="text-2xl font-bold">{p.title}</h2>
          <div className="text-xl mt-2">₹{p.price}</div>
          <div className="mt-4">{p.desc}</div>
          <div className="mt-6">
            <button onClick={handleAdd} className="px-4 py-2 bg-green-600 text-white rounded">Add to Cart</button>
          </div>
        </div>
      </div>
    </div>
  );
}

function CartPage() {
  const [cart, setCart] = useState(readLS('lb_cart_v1', []));
  const navigate = useNavigate();
  useEffect(() => { writeLS('lb_cart_v1', cart); }, [cart]);
  const removeItem = (id) => setCart(c => c.filter(i => i.id !== id));
  const changeQty = (id, delta) => setCart(c => c.map(i => i.id===id?{...i, qty: Math.max(1, i.qty+delta)}:i));
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  if (cart.length===0) return <div className="bg-white p-4 rounded">Cart is empty. <Link to="/">Shop</Link></div>;
  return (
    <div className="bg-white p-4 rounded shadow-sm">
      <h2 className="text-xl font-semibold">Your Cart</h2>
      <div className="mt-4 space-y-3">
        {cart.map(i => (
          <div key={i.id} className="flex items-center justify-between p-2 border rounded">
            <div className="flex items-center gap-3">
              <div className="w-16 h-16 bg-gray-100 flex items-center justify-center">{i.image? <img src={i.image} alt={i.title} className="max-h-full"/> : 'No'}</div>
              <div>
                <div className="font-semibold">{i.title}</div>
                <div>₹{i.price} x {i.qty}</div>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button onClick={()=>changeQty(i.id,-1)} className="px-2">-</button>
              <button onClick={()=>changeQty(i.id,1)} className="px-2">+</button>
              <button onClick={()=>removeItem(i.id)} className="ml-2 underline">Remove</button>
            </div>
          </div>
        ))}
      </div>
      <div className="mt-4 flex justify-between items-center">
        <div className="font-semibold">Total: ₹{total}</div>
        <div>
          <button onClick={()=>navigate('/login')} className="px-3 py-2 bg-blue-600 text-white rounded mr-2">Login to Checkout</button>
          <button onClick={()=>alert('Payment placeholder. Integrate Stripe/PayPal/Razorpay in production.')} className="px-3 py-2 bg-green-600 text-white rounded">Proceed to Payment</button>
        </div>
      </div>
      <div className="mt-3 text-sm text-gray-600">Note: The site supports multiple payment methods in production (Stripe / PayPal / Razorpay). This demo shows a placeholder button.</div>
    </div>
  );
}

// --------- News/Updates (admin pushes updates) ----------
function NewsPage() {
  const news = readLS(LS.NEWS, []);
  return (
    <div className="bg-white p-4 rounded shadow-sm">
      <h2 className="text-xl font-semibold">Updates from Lakshmi Boutique</h2>
      <div className="mt-4 space-y-3">
        {news.length===0 ? <div>No updates yet.</div> : news.map(n => (
          <div key={n.id} className="p-2 border rounded">
            <div className="font-semibold">{n.title}</div>
            <div className="text-sm text-gray-600">{new Date(n.date).toLocaleString()}</div>
            <div className="mt-2">{n.body}</div>
          </div>
        ))}
      </div>
    </div>
  );
}

// --------- Auth (Signup/Login) ----------
function Signup() {
  const navigate = useNavigate();
  const [form, setForm] = useState({ name: '', email:'', password:'' });
  const handle = () => {
    const users = readLS(LS.USERS, []);
    if (users.find(u => u.email === form.email)) { alert('Email already used'); return; }
    const newUser = { id: uid(), name: form.name, email: form.email, password: form.password };
    users.push(newUser); writeLS(LS.USERS, users);
    writeLS(LS.SESS, { id: newUser.id, name: newUser.name, email: newUser.email, isAdmin: false });
    navigate('/');
  };
  return (
    <div className="max-w-md mx-auto bg-white p-4 rounded">
      <h2 className="text-xl font-semibold">Sign up</h2>
      <div className="mt-3 space-y-2">
        <input placeholder="Name" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="w-full p-2 border rounded" />
        <input placeholder="Email" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} className="w-full p-2 border rounded" />
        <input placeholder="Password" type="password" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} className="w-full p-2 border rounded" />
        <div className="flex justify-end">
          <button onClick={handle} className="px-3 py-2 bg-indigo-600 text-white rounded">Create account</button>
        </div>
      </div>
    </div>
  );
}

function Login() {
  const navigate = useNavigate();
  const [form, setForm] = useState({ email:'', password:'' });
  const handle = () => {
    if (form.email === ADMIN_EMAIL && form.password === ADMIN_PASSWORD) {
      writeLS(LS.SESS, { id: 'admin', name: 'Admin', email: ADMIN_EMAIL, isAdmin: true });
      navigate('/admin'); return;
    }
    const users = readLS(LS.USERS, []);
    const u = users.find(uu => uu.email === form.email && uu.password === form.password);
    if (!u) { alert('Invalid credentials'); return; }
    writeLS(LS.SESS, { id: u.id, name: u.name, email: u.email, isAdmin: false });
    navigate('/');
  };
  return (
    <div className="max-w-md mx-auto bg-white p-4 rounded">
      <h2 className="text-xl font-semibold">Login</h2>
      <div className="mt-3 space-y-2">
        <input placeholder="Email" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} className="w-full p-2 border rounded" />
        <input placeholder="Password" type="password" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} className="w-full p-2 border rounded" />
        <div className="flex justify-end">
          <button onClick={handle} className="px-3 py-2 bg-indigo-600 text-white rounded">Login</button>
        </div>
        <div className="text-sm text-gray-600">Admin credentials (demo): {ADMIN_EMAIL} / {ADMIN_PASSWORD}</div>
      </div>
    </div>
  );
}

// --------- Admin Routes & Dashboard ----------
function AdminRoutes() {
  const session = readLS(LS.SESS, null);
  if (!session || !session.isAdmin) return <Navigate to="/login" replace />;
  return (
    <Routes>
      <Route path="/" element={<AdminDashboard />} />
      <Route path="/products" element={<AdminProducts />} />
      <Route path="/news" element={<AdminNews />} />
    </Routes>
  );
}

function AdminDashboard() {
  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div className="bg-white p-4 rounded">Welcome, Admin</div>
      <div className="bg-white p-4 rounded">Manage Products: <Link to="/admin/products" className="underline">Open</Link></div>
      <div className="bg-white p-4 rounded">Post Updates: <Link to="/admin/news" className="underline">Open</Link></div>
    </div>
  );
}

function AdminProducts() {
  const [products, setProducts] = useState(readLS(LS.PRODUCTS, []));
  const [editing, setEditing] = useState(null);
  useEffect(()=> writeLS(LS.PRODUCTS, products), [products]);
  const addBlank = () => setEditing({ id: uid(), title:'', price:0, qty:1, desc:'', image: null });
  const save = (obj) => {
    setProducts(p => {
      const exists = p.find(x=>x.id===obj.id);
      if (exists) return p.map(x=>x.id===obj.id?obj:x);
      return [obj, ...p];
    });
    setEditing(null);
    pushNews(`Product updated`, `Product "${obj.title}" was added/updated by admin.`);
    alert('Saved');
  };
  const remove = (id) => { if (!confirm('Remove product?')) return; setProducts(p=>p.filter(x=>x.id!==id)); pushNews('Product removed', 'A product was removed by admin.'); };
  return (
    <div>
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-semibold">Manage Products</h2>
        <div>
          <button onClick={addBlank} className="px-3 py-2 bg-indigo-600 text-white rounded">Add Product</button>
        </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
        {products.map(p => (
          <div key={p.id} className="bg-white p-3 rounded border">
            <div className="flex justify-between items-start">
              <div>
                <div className="font-semibold">{p.title}</div>
                <div className="text-sm text-gray-600">₹{p.price} | Stock: {p.qty}</div>
              </div>
              <div className="space-x-2">
                <button onClick={()=>setEditing(p)} className="underline">Edit</button>
                <button onClick={()=>remove(p.id)} className="underline text-red-600">Remove</button>
              </div>
            </div>
          </div>
        ))}
      </div>
      {editing && <ProductEditor obj={editing} onCancel={()=>setEditing(null)} onSave={save} />}
    </div>
  );
}

function ProductEditor({ obj, onCancel, onSave }) {
  const [form, setForm] = useState(obj);
  const handleImage = (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => setForm({...form, image: reader.result});
    reader.readAsDataURL(f);
  };
  return (
    <div className="mt-4 bg-white p-4 rounded">
      <h3 className="font-semibold">Edit Product</h3>
      <div className="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
        <input value={form.title} onChange={e=>setForm({...form,title:e.target.value})} className="p-2 border rounded" placeholder="Title" />
        <input type="number" value={form.price} onChange={e=>setForm({...form,price:parseInt(e.target.value||0)})} className="p-2 border rounded" placeholder="Price" />
        <input type="number" value={form.qty} onChange={e=>setForm({...form,qty:parseInt(e.target.value||0)})} className="p-2 border rounded" placeholder="Stock qty" />
        <input type="file" accept="image/*" onChange={handleImage} className="p-2" />
        <textarea value={form.desc} onChange={e=>setForm({...form,desc:e.target.value})} className="p-2 border rounded md:col-span-2" placeholder="Description" />
      </div>
      <div className="mt-3 flex justify-end gap-2">
        <button onClick={onCancel} className="px-3 py-2">Cancel</button>
        <button onClick={()=>onSave(form)} className="px-3 py-2 bg-green-600 text-white rounded">Save</button>
      </div>
    </div>
  );
}

// --------- Admin News ----------
function AdminNews() {
  const [title, setTitle] = useState('');
  const [body, setBody] = useState('');
  const add = () => { if (!title) { alert('Title required'); return; } pushNews(title, body); setTitle(''); setBody(''); alert('Posted'); };
  return (
    <div className="bg-white p-4 rounded">
      <h2 className="font-semibold">Post Update</h2>
      <input value={title} onChange={e=>setTitle(e.target.value)} placeholder="Title" className="w-full p-2 border rounded mt-2" />
      <textarea value={body} onChange={e=>setBody(e.target.value)} placeholder="Body" className="w-full p-2 border rounded mt-2" />
      <div className="flex justify-end mt-2">
        <button onClick={add} className="px-3 py-2 bg-indigo-600 text-white rounded">Post Update</button>
      </div>
    </div>
  );
}

function pushNews(title, body) {
  const news = readLS(LS.NEWS, []);
  news.unshift({ id: uid(), title, body, date: new Date().toISOString() });
  writeLS(LS.NEWS, news);
}

// --------- NotFound ----------
function NotFound() { return <div>Page not found</div>; }
